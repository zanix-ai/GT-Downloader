name: Kirim ke Telegram

on:
  workflow_dispatch:
    inputs:
      pin:
        description: 'PIN rahasia'
        required: true
        type: string
      url:
        description: 'URL file yang mau didownload'
        required: true
        type: string
      ext:
        description: 'Ekstensi file (.mp4, .zip, dll)'
        required: false
        type: string

jobs:
  kirim:
    runs-on: ubuntu-latest

    steps:
      - name: Cek PIN
        run: |
          echo -n "${{ github.event.inputs.pin }}" | sha256sum | grep -q "427a13912500729a67188e4bf5742fc07122e9919e17b3adca8cc1e2ccd5b898"
          if [ $? -ne 0 ]; then
            echo "‚ùå PIN salah!"
            exit 1
          fi

      - name: Download file (curl with wget fallback)
        run: |
          URL="${{ github.event.inputs.url }}"
          EXT="${{ github.event.inputs.ext }}"
          FILENAME="downloaded_file"
          [ -n "$EXT" ] && FILENAME="${FILENAME}${EXT}"

          echo "üì• Downloading from: $URL"
          echo "üì¶ Saving as: $FILENAME"

          curl -L "$URL" --output "$FILENAME" || {
            echo "‚ö†Ô∏è curl failed, trying wget..."
            wget -O "$FILENAME" "$URL" || {
              echo "‚ùå wget also failed."
              exit 1
            }
          }

          if [ ! -s "$FILENAME" ]; then
            echo "‚ùå Downloaded file is empty or missing"
            exit 1
          fi

      - name: Cek hasil download
        run: |
          ls -lah
          file "$FILENAME"

      - name: Kirim ke Telegram
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ ! -f "$FILENAME" ] || [ ! -s "$FILENAME" ]; then
            echo "‚ùå File $FILENAME tidak ditemukan atau kosong."
            exit 1
          fi

          echo "üöÄ Mengirim $FILENAME ke Telegram..."
          curl -F chat_id="$TELEGRAM_CHAT_ID" \
               -F document=@"$FILENAME" \
               "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendDocument"
